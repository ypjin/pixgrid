<style type="text/css">
  #preview{display:none;position:fixed;top:10%;left:50%;width:700px;height:336px;margin:0 0 0 -350px;z-index:31;}
  #preview .ctnr{background:#fff;-webkit-border-radius:3px;-moz-border-radius:3px;border-radius:3px;margin:8px 0 0 0;}
  #preview .ctnr #pv{width:440px;height:240px;background:#484850;margin:18px;}
  #preview .ctnr #pv #pv-img{display:block;margin:auto;}
  #preview .ctnr #inputs{width:200px;margin:18px 18px 18px 0px;}
  #preview .ctnr #inputs textarea{width:100%;height:180px;font:18px/24px 'Helvetica Neue',arial,sans-serif;padding:5px;margin:0;-webkit-border-radius:5px;-moz-border-radius:5px;border-radius:5px;outline:none;border:1px solid #909090;}
  #preview .ctnr #inputs input[type="text"]{width:100%;height:30px;font:18px/30px 'Helvetica Neue',arial,sans-serif;padding:5px;margin:0;-webkit-border-radius:5px;-moz-border-radius:5px;border-radius:5px;outline:none;border:1px solid #909090;margin:5px 0 0 0;}
  #preview .ctnr #inputs textarea:focus,#preview .ctnr #inputs input[type="text"]:focus{border:1px solid #1189fe;}
  #preview .ctnr #btm{width:100%;border-top:1px solid #484850;}
  #preview .ctnr #btm .fn,#preview .ctnr #btm .btn{margin:15px;}
  #preview .ctnr #btm .fn{display:block;color:#858585;font:700 14px/40px "helvetica neue",arial,sans-serif;}
  #preview .cls{width:50px;height:50px;text-indent:-9999px;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;margin:0 0 0 325px;background:url("/images/icons.png") -40px 0 no-repeat;}
  #success,#uploading{margin:15px;}
  #success span,#uploading span{float:left;display:block;font:14px/42px "helvetica neue",arial,sans-serif;}
  #uploading .img{display:inline-block;width:30px;height:30px;background:url("/images/icons.png") -190px 0 no-repeat;margin:5px 0 0 5px;}
  #success .img{display:inline-block;width:30px;height:30px;background:url("/images/icons.png") -221px 0 no-repeat;margin:5px 0 0 5px;}
  .blue{color:#1189fe;}
  .green{color:#0ea20e;}
</style>
<script type="text/javascript">
var pixGrid = {
  data: {}
};
$(function(){
  $(".pht").click(function(){
    $(this).attr('id','current');
    var iurl = $(this).attr('data-url');
    if($("#p-img img").length < 1){
      $("#v #p-img").append("<img id='pimg' src='"+iurl+"' />");
      $('#pimg').load(function(){
        if($(this).height() < $("#v #p-img").height()) {
          var h = ($("#v #p-img").height() - $(this).height())/2;
          $(this).css('padding-top',h);
        }
      });
      $("#v, #shdw").show();
    }
  });
  $("#v .cls").click(function(){
    $("#current").attr('id','');
    $("#v #p-img img").remove();
    $("#v, #shdw").hide();
  });
  $("#v #next").click(function(){
    var next = $("#current").nextAll(".pht");
    console.log(next.length);
    if(next.length === 0){
      next = $(".pht").first()
    }
    var iurl = next.attr('data-url');
    if($("#p-img img").length > 0){
      $("#pimg").attr('src',iurl);
      $('#pimg').load(function(){
        if($(this).height() < $("#v #p-img").height()) {
          var h = ($("#v #p-img").height() - $(this).height())/2;
          $(this).css('padding-top',h);
        }
        $("#current").attr('id','');
        next.attr('id','current');
      });
      $("#v, #shdw").show();
    }
  });
  $("#v #prev").click(function(){
    var prev = $("#current").prev();
    console.log(prev.length);
    if(prev.length === 0){
      prev = $(".pht").last();
    }
    var iurl = prev.attr('data-url');
    if($("#p-img img").length > 0){
      $("#pimg").attr('src',iurl);
      $('#pimg').load(function(){
        if($(this).height() < $("#v #p-img").height()) {
          var h = ($("#v #p-img").height() - $(this).height())/2;
          $(this).css('padding-top',h);
        }
        $("#current").attr('id','');
        prev.attr('id','current');
      });
      $("#v, #shdw").show();
    }
  });
  $("#preview .cls").click(function(){
    jQuery("#pv-img").attr('src','');
    $("#preview, #shdw").hide();
  });
});
</script>
<script type="text/javascript">
  function dragEnter(event) {
    // console.log('dragEnter', event);
    event.stopPropagation();
    event.preventDefault();
  }

  function dragExit(event) {
    // console.log('dragExit', event);
    event.stopPropagation();
    event.preventDefault();
  }

  function dragOver(event) {
    // console.log('dragOver', event);
    event.stopPropagation();
    event.preventDefault();
  }

  function drop(event) {
    // console.log('drop', event);
    event.stopPropagation();
    event.preventDefault();
    
    var data = event.dataTransfer;
    var files = data.files;
    var file;
    var reader;
    
    for(var i = 0; i < files.length; i++) {
      jQuery("#preview, #shdw").show();
      pixGrid.data.file = files[i];
      console.log(pixGrid.data.file, pixGrid.data.file.name);
      reader = new FileReader();
      reader.onloadend = onFileLoaded;
      reader.readAsDataURL(pixGrid.data.file);
      break;
    }
  }

  function onFileLoaded(event) {
    console.log('onFileLoaded', event);

    var pimg = document.getElementById("pv-img");
    pimg.src = event.currentTarget.result;
    pixGrid.data.src = event.currentTarget.result;
    jQuery("#pv-img").load(function(){
      $(".fn").text(pixGrid.data.file.name + " (" + parseInt(Math.ceil(pixGrid.data.file.size/1000)) + "k)")
      if(jQuery(this).height() > $("#pv").height()) {
        $(this).css({"height":$("#pv").height()});
      }else{
        var h = ($("#pv").height() - $(this).height())/2;
        $(this).css('padding-top',h);
      }
    });
  }
  $(function(){
    var dropArea = $("body").get(0);
    dropArea.addEventListener("dragenter", dragEnter, false);
    dropArea.addEventListener("dragexit", dragExit, false);
    dropArea.addEventListener("dragover", dragOver, false);
    dropArea.addEventListener("drop", drop, false);

    $("#fi").change(function (){
      var fileName = $(this).val();
      $(".filename").html(fileName);
    });

    $("#proceed").click(function(){
      $("#proceed").replaceWith("<div id='uploading' class='fr'><span class='blue'>uploading...</span><div class='img'></div></div>");
      var xmlHttpRequest = new XMLHttpRequest();
      xmlHttpRequest.open("POST", '/photos/create.json', true);
      var dashes = '--';
      var boundary = '---pixgrid---';
      var crlf = "\r\n";

      //Post with the correct MIME type (If the OS can identify one)
      if ( pixGrid.data.file.type === '' ){
          filetype = 'application/octet-stream';
      } else {
          filetype = pixGrid.data.file.type;
      }

      //Build a HTTP request to post the file
      var data = dashes + boundary + crlf + "Content-Disposition: form-data;" + "name=\"photo\";" + "filename=\"" + unescape(encodeURIComponent(pixGrid.data.file.name)) + "\"" + crlf + "Content-Type: " + filetype + crlf + crlf + pixGrid.data.src + crlf + dashes + boundary + dashes;

      xmlHttpRequest.setRequestHeader("Accept","text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8");
      xmlHttpRequest.setRequestHeader("Content-Type", "multipart/form-data; boundary=" + boundary);
      xmlHttpRequest.setRequestHeader("Cache-Control","max-age=0");

      xmlHttpRequest.onreadystatechange = function(){ 
        if(xmlHttpRequest.readyState === 4){
          if(xmlHttpRequest.status === 200){
            console.log("Received:"  + xmlHttpRequest.responseText);
            $("#uploading").replaceWith("<div id='success' class='fr'><span class='green'>Success</span><div class='img'></div></div>");
          }else{
            console.log("Error code " + xmlHttpRequest.status);
          }
        }
      }; 
      //Send the binary data
      xmlHttpRequest.send(data);
    });

    $("#trash").click(function(){
      var trash_target = $("#current");
      jQuery.ajax({
        type: 'GET',
        url: "/photos/"+trash_target.attr('data-id')+"/delete",
        dataType: 'html',
        success: function(data, status, xml){
          $("#current").remove();
          $("#v, #shdw").hide();
          if($("#flash").length > 0){
            $("#flash").text("Successfully deleted.");
          }else{
            $("body").append("<div id='flash'>Successfully deleted.</div>")
          }
          setTimeout(function(){$("#flash").fadeOut()},3000);
        },
        error: function(xml, status, error){
          if($("#flash").length > 0){
            $("#flash").text("Fail to delete the photo.");
          }else{
            $("body").append("<div id='flash'>Fail to delete the photo.</div>")
          }
          setTimeout(function(){$("#flash").fadeOut()},3000);
        }
      });
    });
  });
</script>
<div id="dropArea">
  <h3>+ Drag and Drop photos anywhere, to add <span style="color:#1189fe;margin:10px;">or</span> <span id="select-p" class="b-btn">Choose photos to upload</span></h3>
</div>
<div class="sb first">
  <div id="albm-ctnr">
    <div class="albm"><div class="cp"></div></div>
    <div class="albm"><div class="cp"></div></div>
    <div class="albm"><div class="cp"></div></div>
    <div class="clr"></div>
  </div>
</div>
<div class="sb last">
  <h2>All Photos <span class="cts">(<%= obj.meta.total_results %> photos)</span></h2>
  <% var o = obj["photos"] %>
  <div id="p-ctnr">
    <% if(o.length > 0) { %>
      <% for(var i=0;i<o.length;i++){ %>
        <% for (var j in o[i].urls) { %>
          <div class="pht" data-url="<%= o[i].urls.medium_500 %>" data-id="<%= o[i].id %>"><img src="<%= o[i].urls.medium_500 %>" alt="<%= o[i].id %>" height="210" width="210" data-id="<%= o[i].id %>"/></div>
        <%
          break;
        } %>
      <% } %>
    <% }else{ %>
      No results found.
    <% } %>
    <div class="clr"></div>
  </div>
</div>
<div id="v">
  <div id="p-nav">
    <div id="prev" unselectable="on">prev</div>
    <div class="cls" unselectable="on">x</div>
    <div id="next" unselectable="on">next</div>
  </div>
  <div id="p-img"></div>
  <div id="trash" unselectable="on">trash</div>
</div>
<div id="shdw"></div>

<div id="preview">
  <div class="cls" unselectable="on">x</div>
  <div class="ctnr">
    <div id="pv" class="fl">
      <img src="" id="pv-img" />
    </div>
    <div id="inputs" class="fl">
      <textarea id="i-desc" name="description" placeholder="Description" rows="4"></textarea>
      <input id="i-tags" type="text" name="tags" placeholder="Tags" />
    </div>
    <div class="clr"></div>
    <div id="btm">
      <span class="fn fl">filename (size)</span>
      <div class="fr"><span id="proceed" class="btn">Proceed</span></div>
      <div class="clr"></div>
    </div>
  </div>
</div>